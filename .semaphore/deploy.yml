version: v1.0
agent:
  machine:
    type: e1-standard-2
    os_image: ubuntu1804
blocks:
  - name: Deploy
    task:
      secrets:
        - name: aws-frankfurt-s3cfg
        - name: bunnycdn-api-key
      env_vars:
        - name: BUCKET_NAME
          value: robbrazier.com
      jobs:
        - name: 'Deploy to AWS'
          commands:
            - sudo apt -y install s3cmd
            - cache restore robbrazier-$SEMAPHORE_GIT_SHA-$SEMAPHORE_GIT_BRANCH
            - s3cmd --no-mime-magic --acl-public --delete-removed --delete-after sync public/ s3://$BUCKET_NAME | tee changed.txt
            - cat changed.txt | awk -F'-> ' '{ print $2 }' | awk -F"'" '{ print $2 }' | sed -e 's!s3://!https://!g' | xargs -I{} curl -X POST -H Content-Length:0 -H Content-Type:application/json -H Accept:application/json -H "AccessKey:$BUNNY_API_KEY" "https://bunnycdn.com/api/purge?url={}"
  - name: Publish
    task:
      secrets:
        - name: gh-token-docker
      jobs:
        - name: 'Publish to GitHub Packages'
          commands:
            - checkout
            - echo $GH_TOKEN | docker login -u RobBrazier --password-stdin docker.pkg.github.com
            - export GIT_SHA="$(git rev-parse --short HEAD)"
            - docker build -t web .
            - docker tag web docker.pkg.github.com/robbrazier/$SEMAPHORE_GIT_DIR/web:$GIT_SHA
            - docker tag web docker.pkg.github.com/robbrazier/$SEMAPHORE_GIT_DIR/web:latest
            - docker push docker.pkg.github.com/robbrazier/$SEMAPHORE_GIT_DIR/web:$GIT_SHA
            - docker push docker.pkg.github.com/robbrazier/$SEMAPHORE_GIT_DIR/web:latest