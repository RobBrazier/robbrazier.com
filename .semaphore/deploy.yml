version: v1.0
agent:
  machine:
    type: e1-standard-2
    os_image: ubuntu1804
blocks:
  - name: Deploy
    task:
      secrets:
        - name: netlify-authentication
        - name: netlify-robbrazier
     #   - name: linode-s3cfg
        - name: bunnycdn-api-key
        - name: aws-s3
      env_vars:
        - name: BUCKET_NAME
          value: robbrazier.com
      jobs:
        - name: 'Deploy to Netlify'
          commands:
            - npm install -g netlify-cli
            - cache restore robbrazier-$SEMAPHORE_GIT_SHA-$SEMAPHORE_GIT_BRANCH
            - netlify deploy --dir=public --prod
        - name: 'Deploy to Linode'
          commands:
            - sudo apt -y install s3cmd
            - cache restore robbrazier-$SEMAPHORE_GIT_SHA-$SEMAPHORE_GIT_BRANCH
            - s3cmd --token-refresh --region=$AWS_REGION --no-mime-magic --acl-public --delete-removed --delete-after sync public/ s3://$BUCKET_NAME | tee changed.txt
            - cat changed.txt | awk -F'-> ' '{ print $2 }' | awk -F"'" '{ print $2 }' | sed -e 's!s3://!https://!g' | xargs -I{} curl -X POST -H Content-Length:0 -H Content-Type:application/json -H Accept:application/json -H "AccessKey:$BUNNY_API_KEY" "https://bunnycdn.com/api/purge?url={}"