version: v1.0
agent:
  machine:
    type: e1-standard-2
    os_image: ubuntu1804
blocks:
  - name: Deploy
    task:
      secrets:
        - name: aws-frankfurt-s3cfg
        - name: bunnycdn-api-key
      env_vars:
        - name: BUCKET_NAME
          value: robbrazier.com
      jobs:
        - name: 'Deploy to AWS'
          commands:
            - sudo apt -y install s3cmd
            - cache restore robbrazier-$SEMAPHORE_GIT_SHA-$SEMAPHORE_GIT_BRANCH
            - s3cmd --no-mime-magic --acl-public --delete-removed --delete-after sync _site/ s3://$BUCKET_NAME | tee changed.txt
            - cat changed.txt | awk -F'-> ' '{ print $2 }' | awk -F"'" '{ print $2 }' | sed -e 's!s3://!https://!g' | xargs -I{} curl -X POST -H Content-Length:0 -H Content-Type:application/json -H Accept:application/json -H "AccessKey:$BUNNY_API_KEY" "https://bunnycdn.com/api/purge?url={}"
  - name: Deploy to Caprover
    task:
      secrets:
        - name: caprover
      jobs:
        - name: 'Deploy to Caprover'
          commands:
            - checkout --use-cache
            - npm i -g caprover
            - caprover deploy -h $CAPROVER_URL -p $CAPROVER_PASSWORD -b $SEMAPHORE_GIT_BRANCH -a robbrazier
  - name: Publish
    task:
      secrets:
        - name: aws-ecr
      prologue:
        commands:
          # Install the most up-to-date AWS cli
          - sudo pip install awscli
      jobs:
        - name: 'Publish to AWS ECR'
          commands:
            - checkout --use-cache
            - aws ecr get-login --no-include-email | bash
            - export GIT_SHA="${SEMAPHORE_GIT_SHA:0:7}"
            - export VERSION="$(bash .semaphore/version.sh)"
            - export ECR_REPOSITORY="$DOCKER_REGISTRY/$SEMAPHORE_GIT_DIR"
            - docker build -t $ECR_REPOSITORY:$GIT_SHA -t $ECR_REPOSITORY:$VERSION -t $ECR_REPOSITORY:latest .
            - docker push $ECR_REPOSITORY:$GIT_SHA
            - docker push $ECR_REPOSITORY:$VERSION
            - docker push $ECR_REPOSITORY:latest
