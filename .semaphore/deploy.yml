version: v1.0
agent:
  machine:
    type: e1-standard-2
    os_image: ubuntu1804
blocks:
  - name: Deploy
    task:
      secrets:
        - name: aws-frankfurt-s3cfg
        - name: bunnycdn-api-key
      env_vars:
        - name: BUCKET_NAME
          value: robbrazier.com
      jobs:
        - name: 'Deploy to AWS'
          commands:
            - sudo apt -y install s3cmd
            - cache restore robbrazier-$SEMAPHORE_GIT_SHA-$SEMAPHORE_GIT_BRANCH
            - s3cmd --no-mime-magic --acl-public --delete-removed --delete-after sync public/ s3://$BUCKET_NAME | tee changed.txt
            - cat changed.txt | awk -F'-> ' '{ print $2 }' | awk -F"'" '{ print $2 }' | sed -e 's!s3://!https://!g' | xargs -I{} curl -X POST -H Content-Length:0 -H Content-Type:application/json -H Accept:application/json -H "AccessKey:$BUNNY_API_KEY" "https://bunnycdn.com/api/purge?url={}"
  - name: Publish
    task:
      secrets:
        - name: dockerhub-secrets
      jobs:
        - name: 'Publish to Docker Hub'
          commands:
            - checkout
            - echo $DOCKER_PASSWORD | docker login -u $DOCKER_USERNAME --password-stdin
            - export GIT_SHA="$(git rev-parse --short HEAD)"
            - docker build -t $DOCKER_USERNAME/$SEMAPHORE_GIT_DIR:$GIT_SHA -t $DOCKER_USERNAME/$SEMAPHORE_GIT_DIR:latest .
            - docker push $DOCKER_USERNAME/$SEMAPHORE_GIT_DIR:$GIT_SHA
            - docker push $DOCKER_USERNAME/$SEMAPHORE_GIT_DIR:latest